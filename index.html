<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘æ˜¯è³¼ç‰©å°é”äºº</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        @font-face {
            font-family: 'Iansui';
            src: url('https://cdn.jsdelivr.net/npm/iansui@latest/data/Iansui-Regular.woff2') format('woff2');
            font-weight: normal; font-style: normal; font-display: swap;
        }
        :root {
            --rose-quartz: #F7CAC9; --serenity: #92A8D1; --rose-dark: #d68c8b; --serenity-dark: #6e86b3;
            --gradient-bar: linear-gradient(90deg, #92A8D1 0%, #F7CAC9 100%);
            --text-boss: #FFFFFF; --text-cust: #444444; --bg-boss-btn: #5b7bb2; --bg-cust-btn: #e07b7b;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; width: 100%; overflow: hidden; }
        body {
            font-family: "Iansui", "Rounded Mplus 1c", "Microsoft JhengHei", sans-serif;
            margin: 0; padding: 0;
            background: linear-gradient(180deg, var(--serenity) 0%, var(--rose-quartz) 100%);
            display: flex; justify-content: center; align-items: flex-start; padding-top: 10px;
        }
        .container {
            width: 96%; max-width: 1000px; height: calc(100dvh - 110px); 
            background: rgba(255, 255, 255, 0.96); border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); padding: 15px;
            display: flex; flex-direction: column; position: relative; overflow: hidden;
        }
        .boss-mode .container { border: 5px solid var(--serenity); }
        .boss-mode h1, .boss-mode h2, .boss-mode p, .boss-mode label { color: var(--text-cust); }
        .boss-mode #game-view h1 { color: var(--serenity-dark); }
        .cust-mode .container { border: 5px solid var(--rose-quartz); }
        h1 { text-align: center; margin: 5px 0 10px 0; font-size: clamp(1.5rem, 4vw, 2.5rem); color: #444; flex-shrink: 0; }
        h2 { text-align: center; margin: 5px 0; font-size: clamp(1.2rem, 3vw, 1.8rem); color: #555; flex-shrink: 0; }
        .hidden { display: none !important; }
        .btn {
            font-size: clamp(1rem, 2.5vw, 1.4rem); padding: 10px 20px; margin: 5px;
            border: none; border-radius: 50px; cursor: pointer; transition: all 0.2s;
            font-weight: bold; box-shadow: 0 3px 5px rgba(0,0,0,0.15);
            display: inline-block; color: white; flex-shrink: 0; font-family: inherit;
        }
        .btn:active { transform: scale(0.95); } .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--serenity-dark); } .btn-danger { background-color: var(--rose-dark); }
        .btn-success { background-color: #66bb6a; } .btn-warning { background-color: #ff9800; } 
        .btn-info { background-color: #607d8b; } .btn-light { background-color: #f0f0f0; color: #666; border: 1px solid #ccc; }
        .btn-action { 
            font-size: clamp(1.4rem, 4vw, 1.8rem); padding: 12px 60px; margin: 10px auto 0 auto; 
            white-space: nowrap; width: auto; display: block; box-shadow: 0 5px 15px rgba(0,0,0,0.2); flex-shrink: 0;
        }
        .boss-mode .btn-action { background-color: var(--bg-boss-btn); }
        .cust-mode .btn-action { background-color: var(--bg-cust-btn); }
        .btn-speak {
            background-color: #fff; border: 2px solid #ddd; border-radius: 50%; width: 50px; height: 50px;
            font-size: 1.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s;
        }
        .btn-speak:active { transform: scale(0.9); background-color: #f0f0f0; }
        .btn-speak.speaking { background-color: var(--rose-quartz); border-color: var(--rose-dark); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        input, select, textarea {
            font-size: 1.2rem; padding: 8px; margin: 5px 0; border-radius: 8px; border: 2px solid #ddd;
            width: 80%; display: block; margin-left: auto; margin-right: auto; text-align: center; font-family: inherit;
        }
        .store-name-input { font-size: 1.3rem; font-weight: bold; padding: 5px; width: auto; border: 2px dashed #ccc; background: #fff; display: inline-block; margin: 0; text-align: left; border-radius: 5px; color: #333; flex: 1; min-width: 100px; }
        .store-name-input:focus { border-color: var(--serenity); outline: none; background: #fdfdfd; }
        #game-view { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        .script-bubble {
            flex: 0 0 auto; background: #fff; border-radius: 15px; padding: 10px; margin: 5px auto 10px auto;
            font-size: clamp(1.2rem, 3.5vw, 2rem); font-weight: bold; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); color: #333; width: 98%; border: 3px solid; line-height: 1.3;
            min-height: 90px; display: flex; align-items: center; justify-content: center; gap: 15px;
        }
        .boss-mode .script-bubble { border-color: var(--serenity-dark); color: var(--serenity-dark); }
        .cust-mode .script-bubble { border-color: var(--rose-dark); color: var(--rose-dark); }
        .speech-text { flex-grow: 1; text-align: center; }
        .boss-l5-hint {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
            font-size: clamp(0.9rem, 2vw, 1.4rem); color: #e65100; background: #fff3e0; 
            padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 2px dashed #ff9800; text-align: center; flex-shrink: 0;
        }
        .card-panel {
            background: rgba(240, 248, 255, 0.5); border: 2px solid #e0e0e0; flex: 1 1 auto; padding: 10px; border-radius: 15px; margin-bottom: 5px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; text-align: center; 
            overflow-y: auto; -webkit-overflow-scrolling: touch; width: 100%; min-height: 0;
        }
        .item-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; width: 100%; padding-bottom: 10px; }
        .item-card {
            background: white; border-radius: 10px; padding: 8px; width: 120px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1); position: relative; cursor: pointer; color: #333; border: 3px solid transparent;
            transition: transform 0.1s; flex-shrink: 0;
        }
        .item-card:active { transform: scale(0.95); }
        .item-card.selected { border-color: var(--rose-dark); background-color: #fff0f0; }
        .item-card.disabled-item { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); background-color: #eee; }
        .item-img { font-size: 3rem; display: block; margin-bottom: 5px; }
        .item-img-real { width: 70px; height: 70px; object-fit: contain; display: block; margin: 0 auto 5px auto; }
        .item-name { font-size: 1.1rem; font-weight: bold; display: block; }
        .item-stock { font-size: 0.9rem; color: #666; display: block;}
        .item-price { color: #d32f2f; font-weight: bold; font-size: 1.2rem; margin-top: 2px;}
        .badge-oos { 
            position: absolute; top: 5px; right: 5px; width: auto; height: auto; 
            background: rgba(255, 255, 255, 0.9); border-radius: 5px; padding: 2px 5px;
            color: red; font-size: 1.2rem; font-weight: bold; border: 2px solid red; transform: rotate(15deg); z-index: 10;
        }
        .item-card.oos-style .item-img, .item-card.oos-style .item-img-real { filter: grayscale(0.8) opacity(0.6); }
        .check-item {
            font-size: 1.4rem; margin: 5px; padding: 10px; background: white; border-radius: 10px; width: 95%;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 2px solid #eee;
        }
        .check-item.checked { background: #e8f5e9; color: #2e7d32; border-color: #2e7d32; }
        .check-box { width: 30px; height: 30px; border: 2px solid #ccc; display: inline-block; border-radius: 5px; background:white;}
        .check-item.checked .check-box { background: #2e7d32; border-color: #2e7d32; }
        .check-item.checked .check-box::after { content: 'âœ”'; display:block; color:white; font-size:22px; text-align:center; line-height:28px; }
        .pos-list-container { width: 100%; overflow-y: auto; background: #fff; border-radius: 10px; border: 1px solid #ddd; }
        .pos-table { width: 100%; border-collapse: collapse; }
        .pos-table th { background: #f0f0f0; padding: 5px; font-size: 0.9rem; color: #666; position: sticky; top: 0; }
        .pos-table td { padding: 8px 5px; border-bottom: 1px solid #eee; font-size: 1.1rem; text-align: center;}
        .pos-btn-minus, .pos-btn-del { width: 28px; height: 28px; border-radius: 5px; border: none; color: white; font-weight: bold; cursor: pointer; }
        .pos-btn-minus { background: #FF9800; } .pos-btn-del { background: #d32f2f; }
        .quote-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 1.2rem; }
        .quote-table th { border-bottom: 2px solid #ccc; color: #555; padding: 5px; font-size: 1rem; }
        .quote-table td { padding: 8px; border-bottom: 1px dashed #eee; }
        .quote-total-cell { color: #d32f2f; font-weight: bold; }
        .big-input { 
            font-size: 2.5rem; width: 180px; height: 60px; border: 4px solid var(--serenity-dark); border-radius: 15px; 
            color: #333; background: #fff; text-align: center; 
        }
        .math-hint-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        .math-input-group { display: flex; flex-direction: column; align-items: center; }
        .math-label { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        .math-gap { font-size: 1.8rem; width: 100px; padding: 5px; border: 2px solid #ccc; border-radius: 5px; text-align: center; }
        .math-symbol { font-size: 2rem; font-weight: bold; color: var(--rose-dark); }
        .swap-arrow { font-size: 2rem; color: var(--rose-dark); font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .swap-text { font-size: 1rem; color: #666; }
        #admin-view { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .admin-title-bar { flex: 0 0 auto; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        #admin-content-scroll { flex: 1 1 auto; overflow-y: auto; min-height: 0; padding-right: 5px; padding-bottom: 20px; }
        .admin-store-box { background: white; padding: 10px 15px; margin: 10px 0; border-radius: 10px; color: #333; text-align: left; border-left: 8px solid var(--serenity); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .store-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .store-toggle-icon { font-size: 1.5rem; transition: transform 0.3s; margin-right: 10px; color:#666; }
        .store-items { margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .store-items.collapsed { display: none; }
        
        /* New Admin Item Row Layout */
        .admin-item-row { 
            display: flex; align-items: center; gap: 10px; 
            border-bottom: 1px solid #f0f0f0; padding: 15px; 
            background: #fafafa; border-radius: 8px; margin-bottom: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .file-upload-btn { font-size: 0.8rem; padding: 5px 10px; background: #f9f9f9; border: 1px solid #ccc; cursor: pointer; border-radius: 5px; }
        .csv-import-box { background: #f0f4f8; border-radius: 10px; padding: 10px; margin-bottom: 10px; border: 2px dashed #92A8D1; }
        .sync-box { background: #e3f2fd; border-radius: 10px; padding: 10px; margin-bottom: 10px; border: 2px solid #92A8D1; display:flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap:10px;}
        .settings-section { background: #fff3e0; border-radius: 10px; padding: 10px; margin-bottom: 10px; border: 2px solid #ff9800; }
        .oos-row { background: #fff8e1; border: 1px solid #ffcc80; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
        .oos-row label { color: #e65100; font-size: 0.9rem; margin-bottom: 5px; display: block; text-align: left; }
        .bottom-progress-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 90px;
            background: white; display: flex; align-items: flex-start;
            justify-content: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            z-index: 1000; padding-top: 10px;
        }
        .progress-track-container { position: absolute; bottom: 25px; left: 0; right: 0; height: 8px; margin: 0 calc(100% / var(--step-count) / 2); z-index: 0; }
        .progress-track-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #eee; border-radius: 4px; }
        .progress-track-fill { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: var(--gradient-bar); border-radius: 4px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(146, 168, 209, 0.5); }
        .progress-step { flex: 1; text-align: center; position: relative; z-index: 1; height: 100%; display: flex; flex-direction: column; justify-content: flex-start; }
        .progress-step span { font-size: 1.1rem; color: #bbb; font-weight: bold; display: block; margin-top: 5px; transition: color 0.3s; }
        .progress-step::after { content: ''; width: 20px; height: 20px; background: #ddd; border-radius: 50%; position: absolute; bottom: 19px; left: 50%; transform: translateX(-50%); border: 3px solid white; transition: all 0.4s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .progress-step.active span { color: var(--serenity-dark); transform: scale(1.1); }
        .progress-step.active::after { background: var(--rose-dark); transform: translateX(-50%) scale(1.3); box-shadow: 0 0 10px var(--rose-quartz); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 40px; border-radius: 20px; width: 80%; max-width: 500px; text-align: left; box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .modal-box h3 { text-align: center; }
        #setup-scroll-area { flex: 1; overflow-y: auto; padding: 5px; min-height: 0; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; vertical-align: middle; }
        .status-offline { background-color: #ccc; }
        .status-online { background-color: #4caf50; box-shadow: 0 0 5px #4caf50; }
        .status-connecting { background-color: #ff9800; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .edit-img-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .edit-img-box { background: white; padding: 20px; border-radius: 15px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .img-preview-box { width: 100px; height: 100px; border: 2px dashed #ccc; margin: 10px auto; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .img-preview-box img { width: 100%; height: 100%; object-fit: contain; }
        .img-preview-box span { font-size: 3rem; }
        
        .admin-control-bar {
            display: flex; justify-content: space-between; align-items: center; margin: 15px 0;
            padding: 10px; background: #f0f4c3; border-radius: 10px; border: 2px solid #c0ca33;
        }
        .admin-control-group { display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end; }
    </style>
</head>
<body id="body-tag">

<div class="container" id="app">
    <!-- 0. é¦–é  -->
    <div id="home-view">
        <h1 style="color:#444; font-size: 3rem; margin-top: 10vh; font-weight:900;">æˆ‘æ˜¯è³¼ç‰©å°é”äºº</h1>
        <br>
        <div style="display:flex; flex-direction:column; align-items:center; gap:20px;">
            <button class="btn btn-primary" style="width:280px; padding:20px; font-size:1.5rem;" onclick="promptPassword('game')">ğŸ® é–‹å§‹éŠæˆ²</button>
            <button class="btn btn-danger" style="width:280px; padding:20px; font-size:1.5rem;" onclick="promptPassword('admin')">ğŸ› ï¸ å•†åº—å¾Œå°ç®¡ç†</button>
        </div>
    </div>

    <!-- 1. è¨­å®šé  -->
    <div id="setup-view" class="hidden" style="display:flex; flex-direction:column; height:100%;">
        <h2 style="color:#444; font-size:2rem; border-bottom: 2px solid #eee; padding-bottom:10px; flex-shrink:0;">âš™ï¸ èª²ç¨‹è¨­å®š</h2>
        
        <div id="setup-scroll-area">
            <label>1. é¸æ“‡å•†åº— (é›™æ©Ÿéœ€ä¸€è‡´)ï¼š</label>
            <select id="store-select" onchange="updateOOSSelector()"></select>
            <label>2. é¸æ“‡åŠ‡æœ¬ (é›™æ©Ÿéœ€ä¸€è‡´)ï¼š</label>
            <select id="level-select" onchange="updateSetupUI()">
                <option value="1">Level 1ï¼šè‡ªç”±é¸è³¼ (åŸºç¤)</option>
                <option value="2">Level 2ï¼šæ¸…å–®è³¼ç‰© (è¦–è¦ºæŒ‡å®š)</option>
                <option value="3">Level 3ï¼šè‡ªç”±é»é¤ (POS/è½è¦º)</option>
                <option value="4">Level 4ï¼šæŒ‡å®šé»é¤ (POS/è¦–è¦ºä»»å‹™)</option>
                <option value="5">Level 5ï¼šç¼ºè²¨æ›¿ä»£ (æ‡‰è®Š)</option>
                <option value="6">Level 6ï¼šé­”ç‹æ··åˆ (éš¨æ©Ÿ)</option>
            </select>
            <div id="setup-quantity">
                <label id="quantity-label">3. æœ¬å›åˆè¦è²·å¹¾æ¨£å•†å“ï¼Ÿ</label>
                <input type="number" id="item-quantity" value="2" min="1" max="5">
            </div>
            
            <div id="setup-oos-area" class="hidden" style="background:#fff3e0; padding:10px; border-radius:10px; border:2px dashed #ff9800; margin:5px 0;">
                <label style="color:#e65100;">ğŸš¨ æŒ‡å®šç¼ºè²¨æ•¸é‡ï¼š</label>
                <input type="number" id="oos-count" value="1" min="1" max="3" onchange="updateOOSSelector()">
                <div id="oos-pairs-container" style="margin-top:10px;"></div>
                <hr style="border-top:1px dashed #ffb74d;">
                <label style="color:#e65100;">ğŸ¤” ç¼ºè²¨æ™‚å®¢äººçš„å›æ‡‰æ–¹å¼ï¼š</label>
                <select id="alt-response-mode">
                    <option value="specific">é‚£è«‹å•æœ‰ [æ›¿ä»£å“] å—ï¼Ÿ (ç°¡å–®/ç›´æ¥å¼•å°)</option>
                    <option value="open">è«‹å•é‚„æœ‰ä»€éº¼ï¼Ÿ (é€²éš/ç¤¾äº¤æ‡‰å°)</option>
                </select>
            </div>

            <div id="setup-duplicate" class="hidden">
                <label>4. æ¸…å–®å“é …æ˜¯å¦å¯é‡è¤‡ï¼Ÿ</label>
                <select id="allow-duplicate">
                    <option value="no">ä¸é‡è¤‡</option>
                    <option value="yes">å¯é‡è¤‡</option>
                </select>
            </div>
            <label>è¨­å®šæœ¬å¹³æ¿è§’è‰²ï¼š</label>
            <select id="role-select" onchange="updateSetupUI()">
                <option value="boss">æˆ‘æ˜¯è€é—†</option>
                <option value="cust">æˆ‘æ˜¯å®¢äºº</option>
            </select>
            <div id="boss-settings" class="hidden">
                <label>æ•¸å­¸é›£åº¦ï¼š</label>
                <select id="math-diff">
                    <option value="10">10ä»¥å…§åŠ æ¸›</option>
                    <option value="100s">100ä»¥å…§ä¸é€²é€€</option>
                    <option value="100h">100ä»¥å…§é€²é€€ä½</option>
                    <option value="mix">æ··åˆæ¨¡å¼</option>
                </select>
                <label style="color:var(--rose-dark); font-weight:bold;">æ‰¾éŒ¢ç®—å¼æç¤ºï¼š</label>
                <select id="math-hint-mode">
                    <option value="direct">æ¨¡å¼Aï¼šç›´æ¥çµ¦ç®—å¼ (100-76=__)</option>
                    <option value="fill">æ¨¡å¼Bï¼šéœ€å¡«ç©º (___-___=___)</option>
                </select>
                <div id="boss-subtotal-setting-container" class="hidden">
                    <label style="color:var(--serenity-dark); font-weight:bold;">çµå¸³é¡¯ç¤ºç¸½åƒ¹ (å–®é …)ï¼š</label>
                    <select id="show-subtotal-mode">
                        <option value="yes">é¡¯ç¤º (10 x 2 = 20) [ç°¡å–®]</option>
                        <option value="no">éš±è— (10 x 2 = ?) [å›°é›£]</option>
                    </select>
                </div>
            </div>
            <div id="cust-settings" class="hidden">
                <div id="menu-setting" class="hidden">
                    <label>æ˜¯å¦é¡¯ç¤ºåœ–ç‰‡èœå–® (L3å°ˆç”¨)ï¼š</label>
                    <select id="show-menu">
                        <option value="yes">é¡¯ç¤ºèœå–®</option>
                        <option value="no">éš±è— (è½è¦ºè¨˜æ†¶)</option>
                    </select>
                </div>
            </div>
        </div>
        <div style="display:flex; justify-content:center; margin-top: 10px; gap: 10px; padding-bottom: 5px; flex-shrink:0;">
            <button class="btn btn-primary" onclick="startGame()">ğŸš€ é€²å…¥è³£å ´</button>
            <button class="btn btn-danger" onclick="backToHome()">ğŸ  è¿”å›é¦–é </button>
        </div>
    </div>

    <!-- éŠæˆ²ä¸»ç•«é¢ -->
    <div id="game-view" class="hidden">
        <div id="script-area" class="script-bubble hidden"></div>
        <div id="card-area" class="card-panel"></div>
        <button id="main-action-btn" class="btn btn-action" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
    </div>

    <!-- å¾Œå°ç®¡ç† -->
    <div id="admin-view" class="hidden">
        <div class="admin-title-bar">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <h2 style="color:#444; margin:0;">ğŸ“¦ å•†åº—å¾Œå°ç®¡ç†</h2>
                    <button class="btn btn-danger" style="font-size:0.9rem; padding:5px 10px; margin:0;" onclick="backToHome()">ğŸ  è¿”å›é¦–é </button>
                </div>
                <div style="font-size:0.9rem; color:#666; display:flex; align-items:center;">
                    <span id="cloud-status-dot" class="status-dot status-offline"></span>
                    <span id="cloud-status-text">æœªé€£ç·š</span>
                </div>
            </div>
        </div>

        <div id="admin-content-scroll">
            <div class="sync-box">
                <span style="font-weight:bold; color:#555; width:100%; text-align:center;">ğŸ”„ è·¨è£ç½®è³‡æ–™è½‰ç§»</span>
                <button class="btn btn-success" style="font-size:0.9rem; padding:8px 15px; margin:0;" onclick="exportJSON()">ğŸ“¤ åŒ¯å‡ºè¨­å®šæª”</button>
                <label class="btn btn-warning" style="font-size:0.9rem; padding:8px 15px; margin:0; cursor:pointer;">
                    ğŸ“¥ åŒ¯å…¥è¨­å®šæª”
                    <input type="file" accept=".json" style="display:none" onchange="importJSON(this)">
                </label>
                <button class="btn btn-light" style="font-size:0.8rem; padding:5px 10px;" onclick="openConfigModal()">â˜ï¸ é€²éšé›²ç«¯</button>
            </div>

            <div class="settings-section">
                <h4 style="margin:5px 0;">ğŸ™ï¸ TTC èªéŸ³èˆ‡ç™¼éŸ³æ ¡æ­£</h4>
                <div style="margin-bottom:5px;">
                    <label>é¸æ“‡èªéŸ³åŒ…ï¼š</label>
                    <select id="tts-voice-select" onchange="updateTTSVoice()"><option value="">é è¨­</option></select>
                </div>
                <div style="border-top:1px dashed #ccc; padding-top:5px;">
                    <label>ç™¼éŸ³æ ¡æ­£å­—å…¸ (ä¾‹å¦‚: å’Œ->ç¿°)ï¼š</label>
                    <div id="pronounce-list"></div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input type="text" id="p-key" placeholder="åŸæœ¬çš„å­— (å’Œ)" style="flex:1;">
                        <span>â¡</span>
                        <input type="text" id="p-val" placeholder="å”¸æ³• (ç¿°)" style="flex:1;">
                        <button class="btn btn-success" style="padding:5px 10px; font-size:0.9rem;" onclick="addPronounce()">æ–°å¢</button>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="border-color:#f44336; background:#ffebee;">
                <h4 style="margin:5px 0;">ğŸ” å®‰å…¨æ€§è¨­å®š</h4>
                <div style="margin-bottom:10px; font-size:1.1rem; color:#d32f2f;">
                    ç›®å‰è¨­å®šå¯†ç¢¼ï¼š<span id="admin-current-pwd" style="font-weight:bold; background:white; padding:2px 8px; border-radius:4px;"></span>
                </div>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <button class="btn btn-info" style="font-size:0.9rem; padding:5px 10px;" onclick="changePassword()">ä¿®æ”¹å¾Œå°å¯†ç¢¼</button>
                    <button class="btn btn-danger" style="font-size:0.9rem; padding:5px 10px;" onclick="resetPasswordOnly()">âš ï¸ æ¢å¾©é è¨­å¯†ç¢¼</button>
                </div>
            </div>

            <div class="csv-import-box">
                <h4 style="margin:5px 0;">ğŸ“ æ‰¹é‡æ–°å¢å•†å“ (CSV)</h4>
                <div style="display:flex; justify-content:center; gap:10px; align-items:center; flex-wrap:wrap;">
                    <button class="btn" style="font-size:0.9rem; padding:5px 10px; background:#fff; color:#333; border:1px solid #ccc;" onclick="downloadSampleCSV()">â¬‡ï¸ ä¸‹è¼‰ç¯„ä¾‹</button>
                    <label class="btn btn-primary" style="font-size:0.9rem; padding:5px 10px; cursor:pointer;">
                        ğŸ“‚ é¸æ“‡CSV
                        <input type="file" accept=".csv" style="display:none" onchange="processCSV(this)">
                    </label>
                </div>
                <p style="font-size:0.8rem; color:#666; margin:5px 0 0 0;">æ ¼å¼ï¼šå•†åº—åç¨±,å•†å“åç¨±,åº«å­˜</p>
            </div>
            
            <!-- Global Admin Controls -->
            <div class="admin-control-bar">
                <div style="flex:1;">
                    <label style="font-weight:bold; color:#556b2f; margin-right:5px;">ğŸ–¼ï¸ éŠæˆ²é¡¯ç¤ºåœ–ç‰‡å„ªå…ˆç´šï¼š</label>
                    <select id="global-display-mode" onchange="updateGlobalDisplayMode(this.value)" style="padding:5px; font-size:1rem; width:auto; display:inline-block; border:1px solid #c0ca33;">
                        <option value="emoji">Emoji æ¨¡å¼</option>
                        <option value="photo">åœ–ç‰‡æ¨¡å¼ (ç„¡åœ–å‰‡é¡¯ç¤º Emoji)</option>
                    </select>
                </div>
                <div class="admin-control-group">
                     <button class="btn btn-info" style="font-size:1rem; padding:8px 15px; margin:0;" onclick="manualSave()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                     <button class="btn btn-success" style="font-size:1rem; padding:8px 15px; margin:0;" onclick="addNewStore()">+ æ–°å¢å•†åº—</button>
                     <button class="btn btn-primary" style="font-size:1rem; padding:8px 15px; margin:0;" onclick="resetDefaultData()">é‡ç½®é è¨­è³‡æ–™</button>
                </div>
            </div>

            <hr style="border-top:2px dashed #eee; margin:20px 0;">
            <div id="admin-list"></div>
        </div>
    </div>
</div>

<div id="progress-bar" class="bottom-progress-bar hidden"></div>

<div id="pwd-modal" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:center;">
        <h3 style="font-size:1.8rem; margin-bottom:20px;">ğŸ”’ è«‹è¼¸å…¥å¯†ç¢¼</h3>
        <input type="password" id="modal-pwd-input" style="font-size:2rem; width:100%; margin-bottom:20px;">
        <br>
        <button class="btn btn-primary" onclick="checkPassword()">ç¢ºèª</button>
        <button class="btn btn-danger" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<div id="config-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3 style="margin-top:0;">â˜ï¸ é€²éšï¼šGoogle Firebase é€£ç·š</h3>
        <p style="font-size:0.9rem; color:#666;">è‹¥æ‚¨æ‡‚å¾—è¨­å®š Google Firebase Firestoreï¼Œå¯åœ¨æ­¤è²¼ä¸Šè¨­å®šæª”ä»¥å•Ÿç”¨å³æ™‚åŒæ­¥ã€‚</p>
        <textarea id="firebase-config-input" rows="6" style="width:100%; font-size:0.8rem; border:2px solid #ccc; padding:5px; border-radius:5px;" placeholder='åœ¨æ­¤è²¼ä¸Š firebaseConfig JSON (ä¾‹å¦‚: {"apiKey": "...", ...})'></textarea>
        <p id="config-error-msg" style="color:red; font-size:0.8rem; display:none;">æ ¼å¼éŒ¯èª¤æˆ–é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä»£ç¢¼ã€‚</p>
        <br><br>
        <button class="btn btn-success" onclick="saveFirebaseConfig()">ğŸ”— é€£ç·šä¸¦å„²å­˜</button>
        <button class="btn btn-danger" onclick="document.getElementById('config-modal').classList.add('hidden')">é—œé–‰</button>
    </div>
</div>

<!-- åœ–ç‰‡ç·¨è¼¯ Modal -->
<div id="img-edit-modal" class="edit-img-modal hidden">
    <div class="edit-img-box">
        <h4>ğŸ–¼ï¸ ç·¨è¼¯å•†å“åœ–ç‰‡</h4>
        <div class="img-preview-box" id="img-edit-preview"></div>
        
        <div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <label style="font-size:0.9rem; color:#666;">é¸é … Aï¼šè¼¸å…¥ Emoji/æ–‡å­—</label>
            <div style="display:flex; justify-content:center; gap:5px; align-items:center;">
                <input type="text" id="img-edit-icon-input" placeholder="ä¾‹å¦‚: ğŸ" style="width:80px; font-size:1.5rem;" maxlength="5">
                <button class="btn btn-warning" onclick="aiGenerateIcon()" style="padding:5px 8px; font-size:0.8rem;">ğŸª„ æ™ºèƒ½ç”Ÿæˆ</button>
            </div>
            <button class="btn btn-info" onclick="applyIconEdit()" style="padding:5px 10px; font-size:0.9rem; margin-top:5px;">è¨­å®šç‚ºåœ–ç¤º</button>
        </div>
        
        <div style="margin-bottom:15px;">
            <label style="font-size:0.9rem; color:#666;">é¸é … Bï¼šä¸Šå‚³åœ–ç‰‡</label>
            <label class="btn btn-primary" style="display:block; margin:5px auto; width:150px; cursor:pointer; font-size:0.9rem; padding:8px;">
                ğŸ“‚ ä¸Šå‚³åœ–ç‰‡
                <input type="file" id="img-edit-file" accept="image/*" style="display:none" onchange="applyPhotoEdit(this)">
            </label>
        </div>

        <button class="btn btn-danger" onclick="closeImgEdit()">é—œé–‰</button>
    </div>
</div>

<script>
// --- Global State ---
const defaultStores = [
    {id:'s1', name:'ç¾å‘³æ¼¢å ¡åº—', items:[{id:1, name:'æ¼¢å ¡', icon:'ğŸ”', imgType:'icon', stock:5}, {id:2, name:'è–¯æ¢', icon:'ğŸŸ', imgType:'icon', stock:5}, {id:3, name:'å¯æ¨‚', icon:'ğŸ¥¤', imgType:'icon', stock:5}, {id:4, name:'é›å¡Š', icon:'ğŸ—', imgType:'icon', stock:0}]},
    {id:'s2', name:'é™½å…‰æ–‡å…·åº—', items:[{id:1, name:'é‰›ç­†', icon:'âœï¸', imgType:'icon', stock:10}, {id:2, name:'æ©¡çš®æ“¦', icon:'ğŸŸ¦', imgType:'icon', stock:10}, {id:3, name:'ç­†è¨˜æœ¬', icon:'ğŸ““', imgType:'icon', stock:5}, {id:4, name:'å‰ªåˆ€', icon:'âœ‚ï¸', imgType:'icon', stock:5}]},
    {id:'s3', name:'å¿«æ¨‚ä¾¿åˆ©å•†åº—', items:[{id:1, name:'ç‰›å¥¶', icon:'ğŸ¥›', imgType:'icon', stock:5}, {id:2, name:'éºµåŒ…', icon:'ğŸ', imgType:'icon', stock:5}]},
    {id:'s4', name:'ç”œèœœéºµåŒ…åº—', items:[{id:1, name:'ç”œç”œåœˆ', icon:'ğŸ©', imgType:'icon', stock:5}, {id:2, name:'è›‹ç³•', icon:'ğŸ°', imgType:'icon', stock:5}]},
    {id:'s5', name:'å¤¢æƒ³ç©å…·åº—', items:[{id:1, name:'æ©Ÿå™¨äºº', icon:'ğŸ¤–', imgType:'icon', stock:2}, {id:2, name:'å°ç†Š', icon:'ğŸ§¸', imgType:'icon', stock:2}]}
];

let globalData = { stores: [], password: "0000", ttsConfig: { voiceURI: "", replacements: {} }, displayMode: 'emoji' };
let session = {}; let db = null; let useCloud = false; let targetView = '';
let currentEditTarget = { sIdx: null, iIdx: null }; 
let adminExpandedStores = new Set(); // Track expanded stores

function initApp() {
    const saved = localStorage.getItem('shopping_data');
    if (saved) { 
        try { 
            const p=JSON.parse(saved); 
            if(Array.isArray(p)) { globalData.stores=p; globalData.displayMode='emoji'; } // Old version compat
            else { globalData=p; }
            if(!globalData.password)globalData.password="0000"; 
            if(!globalData.ttsConfig)globalData.ttsConfig={voiceURI:"",replacements:{}};
            if(!globalData.displayMode)globalData.displayMode='emoji';
        } catch(e){globalData.stores=JSON.parse(JSON.stringify(defaultStores)); globalData.displayMode='emoji';} 
    } 
    else { globalData.stores = JSON.parse(JSON.stringify(defaultStores)); globalData.displayMode='emoji'; }

    const cc = localStorage.getItem('firebase_config_custom');
    if(cc) try{updateCloudStatus('connecting'); initFirebase(JSON.parse(cc));}catch(e){}
    window.speechSynthesis.onvoiceschanged = populateVoiceList; populateVoiceList();
}
function saveData() { if(useCloud&&db) saveToCloud(); else localStorage.setItem('shopping_data', JSON.stringify(globalData)); }
function initFirebase(cfg) { if(!firebase.apps.length) firebase.initializeApp(cfg); db=firebase.firestore(); subscribeToCloud(); }
function updateCloudStatus(s) { const d=document.getElementById('cloud-status-dot'), t=document.getElementById('cloud-status-text'); if(s==='online'){d.className="status-dot status-online";t.innerText="å·²é€£ç·š";}else if(s==='connecting'){d.className="status-dot status-connecting";t.innerText="é€£ç·šä¸­...";}else{d.className="status-dot status-offline";t.innerText="æœªé€£ç·š";} }
function subscribeToCloud() { db.collection('shopping_data').doc('main').onSnapshot(d=>{useCloud=true;updateCloudStatus('online');if(d.exists){globalData=d.data();refreshUI();}else saveToCloud();}, e=>{useCloud=false;updateCloudStatus('offline');}); }
function saveToCloud() { db.collection('shopping_data').doc('main').set(globalData).catch(e=>alert("å„²å­˜å¤±æ•—")); }
function refreshUI() { if(!document.getElementById('setup-view').classList.contains('hidden')){ updateOOSSelector(); } if(!document.getElementById('admin-view').classList.contains('hidden')) renderAdminList(); }
function compressImage(b64) { return new Promise(r=>{ const i=new Image(); i.src=b64; i.onload=()=>{ const c=document.createElement('canvas'); let w=i.width, h=i.height; if(w>300){h=Math.round((h*300)/w);w=300;} c.width=w;c.height=h; const x=c.getContext('2d'); x.drawImage(i,0,0,w,h); r(c.toDataURL('image/jpeg',0.6)); } }); }

// TTS
function populateVoiceList() { const v=window.speechSynthesis.getVoices().filter(x=>x.lang.includes('zh')); document.getElementById('tts-voice-select').innerHTML='<option value="">é è¨­</option>'+v.map(x=>`<option value="${x.voiceURI}">${x.name}</option>`).join(''); if(globalData.ttsConfig.voiceURI) document.getElementById('tts-voice-select').value=globalData.ttsConfig.voiceURI; }
function updateTTSVoice() { globalData.ttsConfig.voiceURI=document.getElementById('tts-voice-select').value; saveData(); }
function speakText(txt) { if(!txt)return; for(let [k,v] of Object.entries(globalData.ttsConfig.replacements)) txt=txt.split(k).join(v); txt=txt.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g,''); const u=new SpeechSynthesisUtterance(txt); u.lang='zh-TW'; if(globalData.ttsConfig.voiceURI){const v=window.speechSynthesis.getVoices().find(x=>x.voiceURI===globalData.ttsConfig.voiceURI);if(v)u.voice=v;} window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); }
function renderTTSBtn(t) { return `<button class="btn-speak" onclick="speakText('${t.replace(/'/g,"\\'")}');this.classList.add('speaking');setTimeout(()=>this.classList.remove('speaking'),2000);">ğŸ”Š</button>`; }
function updateBubblePrice(v) { const t=v?`ç¸½å…± ${v} å…ƒ`:"ç¸½å…± [ ? ] å…ƒ", s=v?`ç¸½å…±${v}å…ƒ`:"ç¸½å…±å¹¾å…ƒ"; document.querySelector('.speech-text').innerText=t; const b=document.querySelector('#script-area .btn-speak'); if(b) b.setAttribute('onclick', `speakText('${s}'); this.classList.add('speaking'); setTimeout(()=>this.classList.remove('speaking'),2000);`); }
function updateBubbleChange(v) { const t=v?`æ‰¾æ‚¨ ${v} å…ƒ`:"æ‰¾æ‚¨ [ ? ] å…ƒ", s=v?`æ‰¾æ‚¨${v}å…ƒ`:"æ‰¾æ‚¨å¹¾å…ƒ"; document.querySelector('.speech-text').innerText=t; const b=document.querySelector('#script-area .btn-speak'); if(b) b.setAttribute('onclick', `speakText('${s}'); this.classList.add('speaking'); setTimeout(()=>this.classList.remove('speaking'),2000);`); }
function updateBubbleCustom(t) { document.querySelector('.speech-text').innerText=t; const b=document.querySelector('#script-area .btn-speak'); if(b) b.setAttribute('onclick', `speakText('${t.replace(/'/g,"\\'")}'); this.classList.add('speaking'); setTimeout(()=>this.classList.remove('speaking'),2000);`); }

// Admin Functions
function renderPronounceList() { document.getElementById('pronounce-list').innerHTML = Object.entries(globalData.ttsConfig.replacements).map(([k,v])=>`<span style="background:#eee;margin:2px;padding:2px;">${k}â¡${v} <span onclick="remP('${k}')" style="cursor:pointer;color:red;">x</span></span>`).join('')||'(ç„¡)'; }
function addPronounce() { const k=document.getElementById('p-key').value.trim(), v=document.getElementById('p-val').value.trim(); if(k&&v){globalData.ttsConfig.replacements[k]=v; saveData(); renderPronounceList(); document.getElementById('p-key').value='';} }
window.remP = k => { delete globalData.ttsConfig.replacements[k]; saveData(); renderPronounceList(); };
function changePassword() { const n=prompt(`æ–°å¯†ç¢¼ (ç›®å‰:${globalData.password})`); if(n){globalData.password=n; saveData(); updatePasswordDisplay(); alert("OK");} }
function resetPasswordOnly() { if(confirm("é‡ç½®å¯†ç¢¼ç‚º0000ï¼Ÿ")){globalData.password="0000"; saveData(); updatePasswordDisplay(); alert("OK");} }
function updatePasswordDisplay() { const e=document.getElementById('admin-current-pwd'); if(e)e.innerText=globalData.password; }
function exportJSON() { const b=new Blob([JSON.stringify(globalData)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='shop_data.json'; a.click(); }
function importJSON(i) { if(!i.files[0])return; const r=new FileReader(); r.onload=e=>{ try{const d=JSON.parse(e.target.result); if(d.stores){globalData=d; saveData(); renderAdminList(); alert(`âœ… æˆåŠŸåŒ¯å…¥ ${d.stores.length} é–“å•†åº—ï¼\nå¯†ç¢¼èˆ‡è¨­å®šå·²åŒæ­¥æ›´æ–°ã€‚`);}}catch(x){alert("æ ¼å¼éŒ¯èª¤");} }; r.readAsText(i.files[0]); }
function downloadSampleCSV() { const b=new Blob(["å•†åº—,å•†å“,åº«å­˜\næ¼¢å ¡åº—,æ¼¢å ¡,5"],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='sample.csv'; a.click(); }
function processCSV(i) { if(!i.files[0])return; const r=new FileReader(); r.onload=e=>{ alert("CSVåŒ¯å…¥"); }; r.readAsText(i.files[0]); }
function promptPassword(t) { targetView=t; document.getElementById('modal-pwd-input').value = ''; document.getElementById('pwd-modal').classList.remove('hidden'); document.getElementById('modal-pwd-input').focus(); }
function closeModal() { document.getElementById('pwd-modal').classList.add('hidden'); }
function checkPassword() { if(document.getElementById('modal-pwd-input').value===globalData.password){ closeModal(); targetView==='game'?renderSetup():showAdmin(); }else alert("å¯†ç¢¼éŒ¯èª¤ã€‚"); document.getElementById('modal-pwd-input').value=''; }
function openConfigModal() { document.getElementById('config-modal').classList.remove('hidden'); }
function saveFirebaseConfig() { try{const c=JSON.parse(document.getElementById('firebase-config-input').value); localStorage.setItem('firebase_config_custom',JSON.stringify(c)); location.reload();}catch(e){document.getElementById('config-error-msg').style.display='block';} }
function backToHome() { hideAll(); document.getElementById('home-view').classList.remove('hidden'); document.getElementById('body-tag').className=''; document.getElementById('progress-bar').classList.add('hidden'); }
function hideAll() { ['home-view','setup-view','game-view','admin-view'].forEach(id=>document.getElementById(id).classList.add('hidden')); }
function renderSetup() { hideAll(); document.getElementById('setup-view').classList.remove('hidden'); document.getElementById('store-select').innerHTML = globalData.stores.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); updateSetupUI(); }

// ----------------------
// Admin Logic Updates
// ----------------------

window.resetDefaultData = () => {
    if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å•†åº—è³‡æ–™å›åˆ°é è¨­å€¼å—ï¼Ÿ\nç¾æœ‰çš„ä¿®æ”¹å°‡æœƒæ¶ˆå¤±ï¼")) {
        globalData.stores = JSON.parse(JSON.stringify(defaultStores));
        adminExpandedStores.clear();
        saveData();
        renderAdminList();
        alert("å·²é‡ç½®å®Œç•¢ï¼");
    }
};

window.manualSave = () => {
    saveData();
    alert("âœ… è¨­å®šå·²å„²å­˜ï¼");
};

window.updateGlobalDisplayMode = (val) => {
    globalData.displayMode = val;
    saveData();
};

function renderAdminList() {
    // Sync UI with global state
    document.getElementById('global-display-mode').value = globalData.displayMode || 'emoji';

    document.getElementById('admin-list').innerHTML = globalData.stores.map((s, si) => {
        const isOpen = adminExpandedStores.has(si);
        return `
        <div class="admin-store-box">
            <div class="store-header" onclick="toggleStore(${si})">
                <div style="display:flex; align-items:center; flex:1;">
                    <span class="store-toggle-icon">${isOpen ? 'â–²' : 'â–¼'}</span>
                    <input class="store-name-input" type="text" value="${s.name}" onclick="event.stopPropagation()" onchange="updateStoreName(${si}, this.value)">
                </div>
                <button class="btn btn-danger" onclick="event.stopPropagation();delStore(${si})">åˆªé™¤å•†åº—</button>
            </div>
            <div id="st-${si}" class="store-items ${isOpen ? '' : 'collapsed'}">
                ${s.items.map((i,ii) => renderAdminItemRow(si, ii, i)).join('')}
                <div style="text-align:center; padding:10px;">
                    <button class="btn btn-success" onclick="addItem(${si})">+ æ–°å¢å•†å“</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function renderAdminItemRow(si, ii, i) {
    return `
    <div class="admin-item-row">
        <!-- åœ–ç‰‡ (Static display) -->
        <div style="width:60px; height:60px; border:1px solid #ddd; background:#fff; display:flex; align-items:center; justify-content:center; border-radius:8px; overflow:hidden; flex-shrink:0;">
            ${renderItemImg(i, 'small', true)}
        </div>

        <!-- æ›´æ›åœ–ç‰‡æŒ‰éˆ• (Button style) -->
        <button class="btn btn-info" onclick="openImgEdit(${si},${ii})" style="font-size:0.9rem; padding:8px 10px; margin:0 10px; flex-shrink:0; white-space:nowrap;">
            æ›´æ›åœ–ç‰‡
        </button>

        <!-- åç¨± (Middle Left - Shrinkable) -->
        <div style="flex:1; min-width: 100px;">
            <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:2px;">å•†å“åç¨±</label>
            <input type="text" value="${i.name}" onchange="updateItemProp(${si},${ii},'name',this.value)" lang="zh-TW" style="font-size:1.2rem; width:100%; border:1px solid #ccc; padding:8px; border-radius:5px; height:45px;">
        </div>

        <!-- åº«å­˜ (Middle Right - Fixed width) -->
        <div style="flex:0 0 80px;">
             <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:2px; text-align:center;">åº«å­˜</label>
            <input type="number" inputmode="numeric" pattern="[0-9]*" value="${i.stock}" onchange="updateItemProp(${si},${ii},'stock',this.value)" style="width:100%; padding:8px; font-size:1.2rem; border:1px solid #ccc; border-radius:5px; height:45px; text-align:center;">
        </div>

        <!-- åˆªé™¤ (Right) -->
        <div style="flex:0 0 auto; padding-left:10px;">
            <button class="btn btn-danger" onclick="delItem(${si},${ii})" style="padding:10px 15px; height:45px; margin-top:18px;">ğŸ—‘ï¸</button>
        </div>
    </div>`;
}

window.updateStoreName = (si, val) => { globalData.stores[si].name = val; saveData(); };
window.updateItemProp = (si, ii, prop, val) => { 
    if(prop === 'stock') val = parseInt(val) || 0;
    globalData.stores[si].items[ii][prop] = val; 
    saveData(); 
};

window.toggleStore = i => {
    const el = document.getElementById(`st-${i}`);
    if (el.classList.contains('collapsed')) {
        adminExpandedStores.add(i);
    } else {
        adminExpandedStores.delete(i);
    }
    renderAdminList(); // Re-render to update icon and class state correctly
};
window.delStore = i => { 
    if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${globalData.stores[i].name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)){
        globalData.stores.splice(i,1); 
        adminExpandedStores.delete(i); // Clean up set
        saveData(); renderAdminList();
    } 
};
window.delItem = (si,ii) => { 
    if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${globalData.stores[si].items[ii].name}ã€å—ï¼Ÿ`)){
        globalData.stores[si].items.splice(ii,1); saveData(); renderAdminList();
    } 
};
window.addItem = si => { 
    globalData.stores[si].items.push({id:Date.now(), name:"æ–°å“", icon:"ğŸ“¦", imgType:"icon", stock:5}); 
    adminExpandedStores.add(si); // Auto-expand
    saveData(); 
    renderAdminList(); 
};
window.addNewStore = () => { 
    const n=prompt("è«‹è¼¸å…¥æ–°å•†åº—åç¨±ï¼š"); 
    if(n){
        globalData.stores.push({id:'s'+Date.now(),name:n,items:[]}); 
        saveData(); 
        renderAdminList(); 
    }; 
};

// --- Image Editing & AI ---
const emojiMap = {
    'æ¼¢å ¡':'ğŸ”', 'è–¯æ¢':'ğŸŸ', 'å¯æ¨‚':'ğŸ¥¤', 'é›å¡Š':'ğŸ—', 'é‰›ç­†':'âœï¸', 'æ©¡çš®æ“¦':'ğŸŸ¦', 'ç­†è¨˜æœ¬':'ğŸ““', 'å‰ªåˆ€':'âœ‚ï¸', 'ç‰›å¥¶':'ğŸ¥›', 'éºµåŒ…':'ğŸ', 'ç”œç”œåœˆ':'ğŸ©', 'è›‹ç³•':'ğŸ°', 'æ©Ÿå™¨äºº':'ğŸ¤–', 'å°ç†Š':'ğŸ§¸', 'è˜‹æœ':'ğŸ', 'é¦™è•‰':'ğŸŒ', 'è¥¿ç“œ':'ğŸ‰', 'è‘¡è„':'ğŸ‡', 'è‰è“':'ğŸ“', 'è»Š':'ğŸš—', 'é£›æ©Ÿ':'âœˆï¸', 'è²“':'ğŸ±', 'ç‹—':'ğŸ¶', 'é­š':'ğŸŸ', 'èŠ±':'ğŸŒ¸', 'æ›¸':'ğŸ“–', 'çƒ':'âš½', 'è¡£æœ':'ğŸ‘•', 'é‹å­':'ğŸ‘Ÿ', 'å¸½':'ğŸ§¢', 'æ°´':'ğŸ’§', 'ç«':'ğŸ”¥', 'å®¶':'ğŸ '
};

window.openImgEdit = (si, ii) => {
    currentEditTarget = { sIdx: si, iIdx: ii };
    const item = globalData.stores[si].items[ii];
    const preview = document.getElementById('img-edit-preview');
    preview.innerHTML = renderItemImg(item, 'normal', true); // Force raw view in edit
    document.getElementById('img-edit-icon-input').value = (item.imgType==='icon') ? item.icon : '';
    document.getElementById('img-edit-file').value = ''; 
    document.getElementById('img-edit-modal').classList.remove('hidden');
};

window.closeImgEdit = () => {
    document.getElementById('img-edit-modal').classList.add('hidden');
    currentEditTarget = { sIdx: null, iIdx: null };
};

window.aiGenerateIcon = () => {
    const val = document.getElementById('img-edit-icon-input').value.trim();
    if(!val) return alert("è«‹å…ˆè¼¸å…¥æ–‡å­—");
    
    // Simple mock AI matching (Offline)
    let found = emojiMap[val];
    if(!found) {
        // Try partial match
        for(let k in emojiMap) {
            if(val.includes(k)) { found = emojiMap[k]; break; }
        }
    }
    
    if(found) {
        document.getElementById('img-edit-icon-input').value = found;
    } else {
        alert("æ‰¾ä¸åˆ°é©åˆçš„åœ–ç¤ºã€‚\n\nå»ºè­°æ–¹å¼ï¼š\n1. ä¸Šç¶²æœå°‹ä¸¦è¤‡è£½ Emoji\n2. ä½¿ç”¨æ‰‹æ©Ÿ/å¹³æ¿éµç›¤è¼¸å…¥ Emoji");
    }
};

window.applyIconEdit = () => {
    const val = document.getElementById('img-edit-icon-input').value.trim();
    if(!val) return alert("è«‹è¼¸å…¥ Emoji æˆ–æ–‡å­—");
    const { sIdx, iIdx } = currentEditTarget;
    globalData.stores[sIdx].items[iIdx].icon = val;
    globalData.stores[sIdx].items[iIdx].imgType = 'icon';
    saveData();
    renderAdminList();
    closeImgEdit();
};

window.applyPhotoEdit = (input) => {
    if(input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            compressImage(e.target.result).then(base64 => {
                const { sIdx, iIdx } = currentEditTarget;
                globalData.stores[sIdx].items[iIdx].imgData = base64;
                globalData.stores[sIdx].items[iIdx].imgType = 'url';
                saveData();
                renderAdminList();
                closeImgEdit();
            });
        };
        reader.readAsDataURL(input.files[0]);
    }
};

// Enhanced renderItemImg to respect Global Display Mode
// ignoreGlobal: boolean, used in Admin Edit Preview to show raw state
window.renderItemImg = (item, size='normal', ignoreGlobal=false) => { 
    // Logic:
    // 1. If ignoreGlobal is true (Admin Edit Preview), show what item actually has.
    // 2. If Global Mode is 'emoji', ALWAYS show emoji.
    // 3. If Global Mode is 'photo' (default/mixed), show photo if exists, else emoji.
    
    let usePhoto = false;
    
    if (ignoreGlobal) {
        usePhoto = (item.imgType === 'url');
    } else {
        if (globalData.displayMode === 'emoji') {
            usePhoto = false;
        } else {
            // Photo mode (fallback to emoji if no photo)
            usePhoto = (item.imgType === 'url' && item.imgData);
        }
    }

    if(usePhoto && item.imgData) {
        return `<img src="${item.imgData}" class="item-img-real" style="${size==='small'?'width:50px;height:50px;':'width:100px;height:100px;'}">`;
    } else {
        return `<span class="item-img" style="${size==='small'?'font-size:2rem':''}">${item.icon}</span>`;
    }
};

window.switchL5GuestState = () => { 
    session.l5GuestState = 'alt';
    session.step = 1; 
    renderStep(); 
};

initApp();

function updateSetupUI() {
    const l=document.getElementById('level-select').value, r=document.getElementById('role-select').value;
    const bs=document.getElementById('boss-settings'), cs=document.getElementById('cust-settings');
    const bsub = document.getElementById('boss-subtotal-setting-container');
    
    r==='boss'?(bs.classList.remove('hidden'),cs.classList.add('hidden')):(bs.classList.add('hidden'),cs.classList.remove('hidden'),l==='3'?document.getElementById('menu-setting').classList.remove('hidden'):document.getElementById('menu-setting').classList.add('hidden'));
    
    if (r === 'boss' && ['3','4','5'].includes(l)) {
        bsub.classList.remove('hidden');
    } else {
        bsub.classList.add('hidden');
    }

    const q=document.getElementById('quantity-label'), dup=document.getElementById('setup-duplicate'), oos=document.getElementById('setup-oos-area');
    ['1','3'].includes(l)?(q.innerText="3. æœ¬å›åˆè¦è²·å¹¾æ¨£å•†å“/é…èœï¼Ÿ(è‡ªç”±é¸)",dup.classList.add('hidden')):(q.innerText="3. è³¼ç‰©æ¸…å–®è¦æŒ‡å®šå¹¾æ¨£å•†å“ï¼Ÿ(ç³»çµ±æŠ½)",dup.classList.remove('hidden'));
    l==='5'?(oos.classList.remove('hidden'),updateOOSSelector()):oos.classList.add('hidden');
}
function updateOOSSelector() {
    const sid=document.getElementById('store-select').value, s=globalData.stores.find(x=>x.id===sid);
    const cnt=parseInt(document.getElementById('oos-count').value)||1, c=document.getElementById('oos-pairs-container'); c.innerHTML='';
    if(s) { for(let i=1;i<=cnt;i++) {
        let opts=s.items.map(it=>`<option value="${it.id}">${it.name}</option>`).join('');
        let alts=s.items.map((it,idx)=>`<option value="${it.id}" ${idx===i?'selected':''}>${it.name}</option>`).join('');
        c.insertAdjacentHTML('beforeend', `<div class="oos-row"><label>ç¬¬ ${i} çµ„ï¼šç¼ºè²¨å•†å“ â†’ æ›¿ä»£å•†å“</label><div style="display:flex;gap:5px;"><select id="oos-item-${i}" style="flex:1;">${opts}</select><span>â¡</span><select id="alt-item-${i}" style="flex:1;">${alts}</select></div></div>`);
    }}
}
function startGame() {
    const sid=document.getElementById('store-select').value, s=globalData.stores.find(x=>x.id===sid); if(!s) return alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚");
    const lvl=document.getElementById('level-select').value, qty=parseInt(document.getElementById('item-quantity').value);
    session = {
        store:s, level:lvl, role:document.getElementById('role-select').value, step:1, itemsToBuy:[], cart:[],
        bossInputPrice:null, bossInputReceived:null, bossInputChange:null,
        mathDiff:document.getElementById('math-diff').value, mathHintMode:document.getElementById('math-hint-mode').value,
        showMenu:document.getElementById('show-menu').value==='yes', qty:qty,
        altResponseMode:document.getElementById('alt-response-mode').value, oosPairs:[],
        showSubtotal:document.getElementById('show-subtotal-mode').value==='yes',
        l5GuestState:'list'
    };
    let used=[]; session.store.items.forEach(i=>{i.price=getUniquePrice(session.mathDiff,used); used.push(i.price);});

    if(lvl==='5') {
        const cnt=parseInt(document.getElementById('oos-count').value);
        let specIds=[];
        for(let i=1;i<=cnt;i++) {
            let oId=document.getElementById(`oos-item-${i}`).value, aId=document.getElementById(`alt-item-${i}`).value;
            let o=s.items.find(x=>x.id==oId), a=s.items.find(x=>x.id==aId);
            if(o&&a&&o.id===a.id) { let oth=s.items.find(x=>x.id!==o.id); if(oth) a=oth; }
            if(o&&a) { session.oosPairs.push({oos:o, alt:a}); specIds.push(o.id); }
        }
        let minQ=session.oosPairs.length+1; if(qty<minQ) session.qty=minQ;
        session.itemsToBuy=session.oosPairs.map(p=>p.oos);
        let pool=s.items.filter(i=>!specIds.includes(i.id)), need=session.qty-session.itemsToBuy.length, dup=document.getElementById('allow-duplicate').value==='yes';
        for(let k=0;k<need;k++) { if(pool.length===0&&!dup)break; let idx=Math.floor(Math.random()*pool.length); session.itemsToBuy.push(pool[idx]); if(!dup)pool.splice(idx,1); }
    } else if(['2','4','6'].includes(lvl)) {
        let pool=s.items.filter(i=>i.stock>0), dup=document.getElementById('allow-duplicate').value==='yes';
        if(pool.length===0) return alert("å“å‘€ï¼Œæ²’æœ‰åº«å­˜äº†ã€‚");
        if(!dup&&qty>pool.length) session.qty=pool.length;
        for(let i=0;i<session.qty;i++) { if(!dup&&pool.length===0)break; let idx=Math.floor(Math.random()*pool.length); session.itemsToBuy.push(pool[idx]); if(!dup)pool.splice(idx,1); }
    }
    document.getElementById('body-tag').className = session.role==='boss'?'boss-mode':'cust-mode';
    hideAll(); document.getElementById('game-view').classList.remove('hidden'); renderProgressBar(); renderStep();
}
function getUniquePrice(d,u) { let p,c=0; do{p=d==='10'?Math.floor(Math.random()*9)+1:Math.floor(Math.random()*45)+5; c++; if(d==='10'){if(u.filter(x=>x===p).length<3)break;}else{if(!u.includes(p))break;}}while(c<20); return p; }

function nextStep() { if(validateStep()) { session.step++; renderStep(); updateProgressBar(); } }
function validateStep() {
    if(session.role === 'cust' && session.level === '2' && session.step === 1) {
        const unchecked = document.querySelectorAll('.check-item:not(.checked)').length;
        if(unchecked > 0) return alert("é‚„æœ‰ç‰©å“æ²’æœ‰è²·é½Šå–”ï¼Œå†çœ‹ä¸€ä¸‹ã€‚") && false;
    }
    
    if(session.role==='boss') {
        const getV=id=>{const e=document.getElementById(id);if(!e)return null;const v=parseInt(e.value);return isNaN(v)?null:v;};
        if(session.step===1 && ['3','4','5'].includes(session.level) && session.cart.length===0) return alert("ğŸ›’ è«‹å…ˆé»é¸é¤é»ï¼")&&false;
        if(session.step===2) { 
            let v=getV('boss-input-total'); if(v===null) return alert("è«‹è¼¸å…¥æ•¸å­—")&&false; 
            if(['3','4','5'].includes(session.level)) {
                let corr=session.cart.reduce((a,b)=>a+b.price,0); if(v!==corr) return alert("é‡‘é¡ä¸å°å–”ï¼Œæˆ‘å€‘å†è©¦è©¦çœ‹")&&false;
            }
            session.bossInputPrice=v;
        }
        if(session.step===3) { let v=getV('boss-input-received'); if(v===null) return alert("è«‹è¼¸å…¥æ•¸å­—")&&false; if(v<session.bossInputPrice) return alert("éŒ¢å¥½åƒä¸å¤ å–”ï¼Œå†ç®—ç®—çœ‹ï¼Ÿ")&&false; session.bossInputReceived=v; }
        if(session.step===4) { 
            const calcPaid = getV('calc-paid');
            const calcTotal = getV('calc-total');
            if (calcPaid !== null && calcTotal !== null) {
                if (calcPaid !== session.bossInputReceived || calcTotal !== session.bossInputPrice) {
                    return alert("ç®—å¼å¡«éŒ¯å›‰ï¼Œæˆ‘å€‘å†çœ‹ä¸€ä¸‹") && false;
                }
            }
            let v=getV('boss-input-change'); 
            if(v===null) return alert("è«‹è¼¸å…¥æ•¸å­—")&&false; 
            if(v!==session.bossInputReceived-session.bossInputPrice) return alert("é‡‘é¡ä¸å°å–”ï¼Œæˆ‘å€‘å†è©¦è©¦çœ‹")&&false; 
            session.bossInputChange=v; 
        }
    }
    return true;
}

function renderStep() {
    const btn=document.getElementById('main-action-btn'), c=document.getElementById('card-area'), sb=document.getElementById('script-area');
    btn.style.display = 'block'; 
    btn.onclick=nextStep; btn.innerText="ä¸‹ä¸€æ­¥"; btn.classList.remove('btn-success'); c.innerHTML=''; sb.classList.remove('hidden');
    const setBubble = (d,s) => { sb.innerHTML = renderTTSBtn(s||d) + `<span class="speech-text">${d}</span>`; };
    
    if(session.level==='5') renderL5(c, setBubble, btn);
    else if(['3','4'].includes(session.level)) renderL34(c, setBubble, btn);
    else renderL12(c, setBubble, btn);
    
    // End Check Logic: Guest finishes at step 5, Boss at step 4
    if(session.role==='boss' && session.step>4) renderEndScreen(c,sb,btn);
    if(session.role==='cust' && session.step>4) renderEndScreen(c,sb,btn); // L5 Guest merged to 4 steps
}

function renderL12(c, setBubble, btn) {
    if(session.step===1) {
        if(session.role==='boss') { c.innerHTML=`<h1>â³</h1><h2>ç­‰å¾…å®¢äºº...</h2>`; btn.innerText="å®¢äººä¾†äº†"; setBubble("ä½ å¥½ï¼Œæ­¡è¿å…‰è‡¨ï¼"); }
        else { setBubble(session.level==='2'?"æˆ‘è¦è²·é€™äº›":"è€é—†ä½ å¥½ï¼Œæˆ‘è¦è²·æ±è¥¿"); c.innerHTML=session.level==='2'?`<h2>ğŸ“‹ æ¸…å–®</h2>${session.itemsToBuy.map(i=>`<div class="check-item" onclick="this.classList.toggle('checked')">${renderItemImg(i,'small')}<span>${i.name}</span><div class="check-box"></div></div>`).join('')}`:`<h2>ğŸ›ï¸ æŒ‡ä»¤</h2><p style="font-size:2rem">è«‹æŒ‘é¸ <span style="color:var(--rose-dark);font-weight:bold;">${session.qty}</span> æ¨£å•†å“</p>`; btn.innerText="æŒ‘å¥½äº†"; }
    } else if(session.step===2) {
        if(session.role==='cust') { setBubble("è€é—†ï¼Œè«‹å•å¤šå°‘éŒ¢ï¼Ÿ"); c.innerHTML=`<h1>ğŸ—£ï¸</h1>`; btn.innerText="èªªå®Œäº†"; }
        else { setBubble("ç¸½å…± [ ? ] å…ƒ", "ç¸½å…±å¹¾å…ƒ"); c.innerHTML=`<h2>ğŸ“‹ åƒ¹ç›®è¡¨</h2><div class="item-grid">${session.store.items.map(i=>`<div class="item-card">${renderItemImg(i)}<span>${i.name} $${i.price}</span></div>`).join('')}</div><hr><label>ç¸½å…±ï¼Ÿ</label><input type="number" id="boss-input-total" class="big-input" inputmode="numeric" pattern="[0-9]*" oninput="updateBubblePrice(this.value)">`; btn.innerText="å ±åƒ¹"; }
    } else renderCommon(session.step, c, setBubble, btn);
}

function renderL34(c, setBubble, btn) {
    if(session.step===1) {
        if(session.role==='boss') { setBubble("å¥½çš„ï¼Œæˆ‘å¹«ä½ é»é¤"); renderPOS(c); btn.innerText="é»é¤å®Œç•¢"; }
        else { setBubble(session.level==='4'?"è€é—†ï¼Œæˆ‘è¦é»...(çœ‹æ¸…å–®)":"è€é—†ï¼Œæˆ‘è¦é»...(è‡ªå·±æ±ºå®š)"); c.innerHTML=`<h2>${session.level==='4'?'ğŸ“ ä»»å‹™':'ğŸ¤” è«‹æŒ‘é¸'}</h2>` + (session.level==='4'?session.itemsToBuy.map(i=>`<div style="font-size:1.5rem;margin:10px;">ğŸ”¹ ${i.name}</div>`).join(''):(session.showMenu?session.store.items.map(i=>`<div style="display:inline-block;margin:10px;">${renderItemImg(i,'small')}<br>${i.name}</div>`).join(''):"<h2>ğŸ‘‚ (ç„¡èœå–®)</h2>")); btn.innerText="é»å®Œäº†"; }
    } else if(session.step===2) {
        if(session.role==='cust') { setBubble("è«‹å•å¤šå°‘éŒ¢ï¼Ÿ"); c.innerHTML=`<h1>ğŸ—£ï¸</h1>`; btn.innerText="èªªå®Œäº†"; }
        else { setBubble("ç¸½å…± [ ? ] å…ƒ", "ç¸½å…±å¹¾å…ƒ"); renderCheckoutList(c); btn.innerText="å ±åƒ¹"; }
    } else renderCommon(session.step, c, setBubble, btn);
}

function renderL5(c, setBubble, btn) {
    if(session.step===1) {
        if(session.role==='boss') {
            let h = session.oosPairs.map(p => `${p.oos.name}âŒ â¡ ${p.alt.name}â­•`).join('ã€');
            c.innerHTML = `<div class="boss-l5-hint" title="${h}">ğŸ’¡ ç¼ºè²¨æç¤ºï¼š${h}</div>`; renderPOS(c, h); setBubble("ä½ å¥½ï¼Œæ­¡è¿å…‰è‡¨ï¼"); btn.innerText="é»é¤å®Œç•¢";
        } else {
            // Guest Logic Merged
            if(session.l5GuestState === 'alt') {
                 if(session.altResponseMode==='open') { setBubble("è«‹å•é‚„æœ‰ä»€éº¼ï¼Ÿ"); c.innerHTML=`<h2>ğŸ’¡ é–‹æ”¾å¼è©¢å•</h2><p>å› ç‚ºç¼ºè²¨äº†ï¼Œè«‹è©¢å•è€é—†é‚„æœ‰ä»€éº¼å¯ä»¥è²·ã€‚</p>`; }
                 else { 
                    let an = session.oosPairs.map(p=>p.alt.name).join('ã€'); setBubble(`é‚£è«‹å•æœ‰ ${an} å—ï¼Ÿ`);
                    let arrows = session.oosPairs.map(p => `<div style="display:flex; align-items:center; gap:5px; margin:10px; background:#fff; padding:10px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);"><div class="item-card oos-style" style="transform:scale(0.8);">${renderItemImg(p.oos)}<div class="badge-oos">ç¼ºè²¨</div></div><div class="swap-arrow">â¡<div class="swap-text">æ›</div></div><div class="item-card" style="transform:scale(0.8);">${renderItemImg(p.alt)}</div></div>`).join('');
                    c.innerHTML=`<h2>ğŸ’¡ æ›¿ä»£æ–¹æ¡ˆ</h2><div style="display:flex;justify-content:center;flex-wrap:wrap;">${arrows}</div>`;
                }
                btn.innerText="æˆ‘é»å¥½é¤äº†ï¼Œä¸‹ä¸€æ­¥";
                btn.onclick = () => { session.step++; renderStep(); updateProgressBar(); };
            } else {
                let n = session.itemsToBuy.map(i=>i.name).join('ã€'); setBubble(`è€é—†ï¼Œæˆ‘è¦è²· ${n}`); 
                c.innerHTML = `<h2>ğŸ›ï¸ è³¼ç‰©æ¸…å–®</h2><div style="display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">${session.itemsToBuy.map(i => `<div class="item-card">${renderItemImg(i)}<span class="item-name">${i.name}</span></div>`).join('')}</div><button class="btn btn-warning" onclick="switchL5GuestState()">ğŸ’¬ è€é—†èªªæ²’è²¨...</button>`;
                btn.style.display = 'none';
            }
        }
    } else if(session.step===2) {
        if(session.role==='boss') { setBubble("ç¸½å…± [ ? ] å…ƒ", "ç¸½å…±å¹¾å…ƒ"); renderCheckoutList(c); btn.innerText="å ±åƒ¹"; }
        else { setBubble("è«‹å•å¤šå°‘éŒ¢ï¼Ÿ"); c.innerHTML=`<h1>ğŸ—£ï¸</h1>`; btn.innerText="èªªå®Œäº†"; session.l5GuestState = 'list'; }
    } else renderCommon(session.step, c, setBubble, btn);
}

function renderCommon(ph, c, setBubble, btn) {
    if(ph===3) {
        if(session.role==='boss') { setBubble("æ”¶éŒ¢ä¸­...", "æ”¶éŒ¢ä¸­"); c.innerHTML=`<h2>ğŸ’µ æ”¶éŒ¢</h2><p>æ‡‰æ”¶ $${session.bossInputPrice}</p><label>æ”¶äº†å¤šå°‘ï¼Ÿ</label><input type="number" id="boss-input-received" class="big-input" inputmode="numeric" pattern="[0-9]*">`; btn.innerText="ç¢ºèª"; }
        else { setBubble("ä»˜éŒ¢çµ¦è€é—†"); c.innerHTML=`<h1>ğŸ’°</h1>`; btn.innerText="çµ¦éŒ¢"; }
    } else if(ph===4) {
        if(session.role==='boss') {
            const r=session.bossInputReceived, p=session.bossInputPrice;
            if(r==p) {
                setBubble(`æ”¶æ‚¨ ${r} å…ƒï¼Œè¬è¬å…‰è‡¨ï¼`); c.innerHTML=`<h1>âœ… å‰›å¥½</h1>`;
                btn.innerText="èªªå®Œäº†ï¼ŒçµæŸäº¤æ˜“"; btn.classList.add('btn-success'); btn.onclick=()=>{session.step=100;renderStep();};
            } else {
                setBubble("æ‰¾æ‚¨ [ ? ] å…ƒ", "æ‰¾æ‚¨å¹¾å…ƒ");
                let hint = session.mathHintMode==='direct' ? `<div style="font-size:2rem;">${r} - ${p} = <span style="color:var(--rose-dark)">?</span></div>` : `<div class="math-hint-container"><div class="math-input-group"><span class="math-label">å®¢ä»˜</span><input type="number" id="calc-paid" class="math-gap"></div><div class="math-symbol">-</div><div class="math-input-group"><span class="math-label">ç¸½é¡</span><input type="number" id="calc-total" class="math-gap"></div><div class="math-symbol">=</div><span>?</span></div>`;
                c.innerHTML=`<h2>ğŸ§® æ‰¾éŒ¢</h2>${hint}<hr><label>æ‰¾å¤šå°‘ï¼Ÿ</label><input type="number" id="boss-input-change" class="big-input" inputmode="numeric" pattern="[0-9]*" oninput="updateBubbleChange(this.value)">`;
                btn.innerText="ç¢ºèªé‡‘é¡";
                btn.onclick = () => {
                    if(validateStep()) {
                        setBubble(`æ”¶æ‚¨ ${r} å…ƒï¼Œæ‰¾æ‚¨ ${session.bossInputChange} å…ƒï¼Œè¬è¬å…‰è‡¨ï¼`);
                        c.querySelectorAll('input').forEach(i=>i.disabled=true);
                        btn.innerText="èªªå®Œäº†ï¼ŒçµæŸäº¤æ˜“"; btn.classList.add('btn-success');
                        btn.onclick=()=>{session.step=100;renderStep();};
                    }
                };
            }
        } else {
            setBubble("è¬è¬"); // Guest say thanks
            c.innerHTML=`<h2>â³ ç­‰å¾…æ‰¾éŒ¢...</h2>`; btn.innerText="æ‹¿ç™¼ç¥¨/æ‰¾éŒ¢"; btn.onclick=()=>{session.step=100;renderStep();}; 
        }
    }
}

function renderCheckoutList(c) {
    let grp={}; session.cart.forEach(x=>{if(!grp[x.id])grp[x.id]={...x,qty:0};grp[x.id].qty++;});
    let h=Object.values(grp).map(i=>`<tr><td>${i.name}</td><td>$${i.price}</td><td>x${i.qty}</td><td class="quote-total-cell">${session.showSubtotal?`$${i.price*i.qty}`:'?'}</td></tr>`).join('');
    c.innerHTML=`<h2>ğŸ§¾ è¨‚å–®ç¢ºèª</h2><table class="quote-table"><thead><tr><th>å“é …</th><th>å–®åƒ¹</th><th>æ•¸é‡</th><th>ç¸½åƒ¹</th></tr></thead><tbody>${h}</tbody></table><hr><label>ç¸½å…±ï¼Ÿ</label><input type="number" id="boss-input-total" class="big-input" inputmode="numeric" pattern="[0-9]*" oninput="updateBubblePrice(this.value)">`;
}
function renderPOS(c, h=null) {
    let grp={}; session.cart.forEach(x=>{if(!grp[x.id])grp[x.id]={...x,qty:0};grp[x.id].qty++;});
    let its=session.store.items.map(i=>{
        let inC=session.cart.filter(x=>x.id===i.id).length, rem=i.stock-inC, dis=rem<=0?'disabled-item':'', oos=(session.level==='5'&&session.oosPairs.find(p=>p.oos.id===i.id))?'<div class="badge-oos">ç¼ºè²¨</div>':'';
        return `<div class="item-card ${dis}" onclick="${rem>0?`addToCart(${i.id})`:''}">${oos}${renderItemImg(i,'small')}<span>${i.name}</span><span style="font-size:0.8rem">å‰©${rem}</span></div>`;
    }).join('');
    let lst=Object.values(grp).map(i=>`<tr><td>${i.name}</td><td>x${i.qty}</td><td><button class="pos-btn-minus" onclick="remOne(${i.id})">â–</button></td><td><button class="pos-btn-del" onclick="remAll(${i.id})">âœ–</button></td></tr>`).join('')||'<tr><td colspan="4">(ç©º)</td></tr>';
    c.innerHTML=`${h?`<div class="boss-l5-hint">ğŸ’¡ æç¤ºï¼š${h}</div>`:''}<div style="display:flex;width:100%;gap:10px;flex:1;min-height:0;"><div style="flex:2;overflow-y:auto;" class="item-grid">${its}</div><div style="flex:1;background:#eee;border-radius:10px;padding:5px;overflow-y:auto;" class="pos-list-container"><table class="pos-table"><thead><tr><th>å“å</th><th>æ•¸</th><th>æ¸›</th><th>åˆª</th></tr></thead><tbody>${lst}</tbody></table></div></div>`;
}
function addToCart(id) {
    let i=session.store.items.find(x=>x.id==id);
    if(session.level==='5') {
        if(session.oosPairs.find(p=>p.oos.id===id)) { 
            updateBubbleCustom(`æŠ±æ­‰ï¼Œ${i.name} è³£å®Œäº†`); 
            return; 
        } else if(session.oosPairs.find(p=>p.alt.id===id)) {
            updateBubbleCustom(`æœ‰å–”ï¼Œæˆ‘å€‘æœ‰ ${i.name}`);
        } else {
            updateBubbleCustom(`å¥½çš„ï¼Œ${i.name}`);
        }
    }
    session.cart.push({id:i.id,name:i.name,price:i.price}); 
    renderPOS(document.getElementById('card-area'), session.level==='5'?session.oosPairs.map(p => `${p.oos.name}âŒâ¡${p.alt.name}â­•`).join('ã€'):null);
}
function remOne(id){ let idx=session.cart.findIndex(x=>x.id===id); if(idx!==-1)session.cart.splice(idx,1); renderPOS(document.getElementById('card-area')); }
function remAll(id){ session.cart=session.cart.filter(x=>x.id!==id); renderPOS(document.getElementById('card-area')); }
function renderProgressBar() {
    const b=document.getElementById('progress-bar'); b.classList.remove('hidden');
    let steps=[];
    if(session.level==='5') steps=['é»é¤/è©¢å•', 'å ±åƒ¹', 'ä»˜éŒ¢', 'æ‰¾éŒ¢/å®Œæˆ'];
    else if(['3','4'].includes(session.level)) steps=['é»é¤/POS', 'å ±åƒ¹', 'æ”¶éŒ¢', 'æ‰¾éŒ¢/å®Œæˆ'];
    else steps=['é¸è³¼/æ¸…å–®', 'å ±åƒ¹', 'æ”¶éŒ¢', 'æ‰¾éŒ¢/å®Œæˆ'];
    b.style.setProperty('--step-count', steps.length);
    b.innerHTML=`<div class="progress-track-container"><div class="progress-track-bg"></div><div class="progress-track-fill" id="progress-track-fill"></div></div>`+steps.map((s,i)=>`<div class="progress-step" id="ps-${i}"><span>${s}</span></div>`).join('');
    updateProgressBar();
}
function updateProgressBar() {
    let idx = session.step - 1;
    const total = document.querySelectorAll('.progress-step').length; if(idx>=total) idx=total-1;
    document.querySelectorAll('.progress-step').forEach((el, i) => { i<=idx?el.classList.add('active'):el.classList.remove('active'); });
    const fill = document.getElementById('progress-track-fill'); if(fill) fill.style.width = ((idx/(total-1))*100) + "%";
}
function renderEndScreen(c, sb, btn) { sb.classList.add('hidden'); c.innerHTML=`<h1 style="font-size:4rem;color:var(--rose-dark);margin-top:50px;">ğŸ‰ äº¤æ˜“æˆåŠŸï¼</h1>`; btn.innerText="ğŸ  è¿”å›é¦–é "; btn.classList.remove('btn-success'); btn.onclick=()=>location.reload(); document.getElementById('progress-bar').classList.add('hidden'); }
// Other Utils same as v50
function renderItemImg(item, size='normal') { return item.imgType==='url'&&item.imgData?`<img src="${item.imgData}" class="item-img-real" style="${size==='small'?'width:50px;height:50px;':'width:100px;height:100px;'}">`:`<span class="item-img" style="${size==='small'?'font-size:2rem':''}">${item.icon}</span>`; }
function showAdmin() { hideAll(); document.getElementById('admin-view').classList.remove('hidden'); renderAdminList(); renderPronounceList(); updatePasswordDisplay(); }
function updateBubblePrice(v) { const t=v?`ç¸½å…± ${v} å…ƒ`:"ç¸½å…± [ ? ] å…ƒ", s=v?`ç¸½å…±${v}å…ƒ`:"ç¸½å…±å¹¾å…ƒ"; document.querySelector('.speech-text').innerText=t; const b=document.querySelector('#script-area .btn-speak'); if(b) b.setAttribute('onclick', `speakText('${s}'); this.classList.add('speaking'); setTimeout(()=>this.classList.remove('speaking'),2000);`); }
function updateBubbleChange(v) { const t=v?`æ‰¾æ‚¨ ${v} å…ƒ`:"æ‰¾æ‚¨ [ ? ] å…ƒ", s=v?`æ‰¾æ‚¨${v}å…ƒ`:"æ‰¾æ‚¨å¹¾å…ƒ"; document.querySelector('.speech-text').innerText=t; const b=document.querySelector('#script-area .btn-speak'); if(b) b.setAttribute('onclick', `speakText('${s}'); this.classList.add('speaking'); setTimeout(()=>this.classList.remove('speaking'),2000);`); }
function updateBubbleCustom(t) { document.querySelector('.speech-text').innerText=t; const b=document.querySelector('#script-area .btn-speak'); if(b) b.setAttribute('onclick', `speakText('${t.replace(/'/g,"\\'")}'); this.classList.add('speaking'); setTimeout(()=>this.classList.remove('speaking'),2000);`); }
</script>
</body>
</html>